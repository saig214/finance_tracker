{% extends "base.html" %}

{% block title %}Categorization Rules{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1>Categorization Rules</h1>
    <p class="page-subtitle">Automatically categorize transactions based on patterns</p>
  </div>
  <a href="/rules/create" class="btn btn-primary">+ Create Rule</a>
</div>

{% if rules %}
<div class="rules-grid">
  {% for rule in rules %}
  <div class="rule-card">
    <div class="rule-card-header">
      <div class="rule-title-section">
        <h3 class="rule-name">{{ rule.name }}</h3>
        <div class="rule-meta">
          <span class="rule-priority-badge">Priority: {{ rule.priority }}</span>
          {% if rule.is_active %}
          <span class="badge badge-success">Active</span>
          {% else %}
          <span class="badge badge-inactive">Inactive</span>
          {% endif %}
        </div>
      </div>

      {% if rule.transaction_count is defined and rule.transaction_count > 0 %}
      <div class="transaction-count clickable" onclick="toggleTransactions({{ rule.id }}, this)" title="Click to view transactions">
        <div class="count-number">{{ rule.transaction_count }}</div>
        <div class="count-label">transactions</div>
      </div>
      {% else %}
      <div class="transaction-count empty">
        <div class="count-number">0</div>
        <div class="count-label">transactions</div>
      </div>
      {% endif %}
    </div>

    <div class="rule-card-body">
      <div class="rule-section">
        <div class="section-label">Conditions</div>
        {% if rule.conditions and rule.conditions.rules %}
        <div class="conditions-list">
          {% for cond in rule.conditions.rules %}
          <div class="condition-badge">
            <span class="condition-field">{{ cond.field }}</span>
            <span class="condition-operator">{{ cond.operator }}</span>
            <code class="condition-value">{{ cond.value }}</code>
          </div>
          {% endfor %}
          {% if rule.conditions.rules|length > 1 %}
          <div class="logic-badge">{{ rule.conditions.logic }}</div>
          {% endif %}
        </div>
        {% else %}
        <span class="text-muted">No conditions defined</span>
        {% endif %}
      </div>

      <div class="rule-section">
        <div class="section-label">Action</div>
        <div class="action-info">
          {% if rule.merchant %}
          <div class="action-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span>Set merchant to: <strong>{{ rule.merchant.name }}</strong></span>
          </div>
          {% if rule.merchant.default_category %}
          <div class="action-item sub-action">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
            <span>Auto-category: {{ rule.merchant.default_category.name }}</span>
          </div>
          {% endif %}
          {% elif rule.category %}
          <div class="action-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>Set category to: <strong>{{ rule.category.name }}</strong></span>
          </div>
          {% else %}
          <span class="text-muted">No target assigned</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="rule-card-actions">
      <button class="btn btn-secondary btn-sm" onclick="toggleTransactions({{ rule.id }}, null)" title="View mapped transactions">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Transactions
      </button>
      <button class="btn btn-primary btn-sm" onclick="reapplyRule({{ rule.id }})" id="reapplyBtn-{{ rule.id }}">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        Reapply
      </button>
      <button class="btn btn-secondary btn-sm" onclick="editRule({{ rule.id }})">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
        Edit
      </button>
      <button class="btn btn-danger-outline btn-sm" onclick="deleteRule({{ rule.id }})">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        Delete
      </button>
    </div>

    <!-- Expandable transactions panel -->
    <div class="rule-transactions-panel" id="txPanel-{{ rule.id }}" style="display: none;">
      <div class="tx-panel-loading" id="txLoading-{{ rule.id }}">
        <div class="spinner"></div> Loading transactions...
      </div>
      <div id="txContent-{{ rule.id }}"></div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="empty-state">
  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <path
      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
    </path>
  </svg>
  <h3>No rules created yet</h3>
  <p>Create your first rule to automatically categorize transactions based on patterns.</p>
  <a href="/rules/create" class="btn btn-primary">Create Your First Rule</a>
</div>
{% endif %}

<script>
  function editRule(ruleId) {
    window.location.href = `/rules/${ruleId}/edit`;
  }

  function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule?')) {
      fetch(`/rules/${ruleId}`, { method: 'DELETE' })
        .then(response => {
          if (response.ok) {
            notyf.success('Rule deleted');
            setTimeout(() => window.location.reload(), 600);
          } else {
            notyf.error('Failed to delete rule');
          }
        })
        .catch(() => notyf.error('Error deleting rule'));
    }
  }

  async function reapplyRule(ruleId) {
    const btn = document.getElementById(`reapplyBtn-${ruleId}`);
    btn.disabled = true;

    try {
      const response = await fetch(`/rules/${ruleId}/reapply`, { method: 'POST' });
      if (!response.ok) throw new Error('Failed to reapply');
      const data = await response.json();

      const updated = data.transactions_updated || 0;
      const skipped = data.transactions_skipped || 0;
      let msg = `${updated} transaction${updated !== 1 ? 's' : ''} updated`;
      if (skipped > 0) msg += `, ${skipped} manual skipped`;
      notyf.success({ message: msg, duration: 5000 });

      // Refresh the transaction count badge
      const card = btn.closest('.rule-card');
      const countEl = card.querySelector('.count-number');
      if (countEl) {
        const txRes = await fetch(`/rules/${ruleId}/transactions?page=1&page_size=1`);
        if (txRes.ok) {
          const txData = await txRes.json();
          countEl.textContent = txData.total;
          const countWrapper = countEl.closest('.transaction-count');
          if (txData.total > 0) {
            countWrapper.classList.remove('empty');
            countWrapper.classList.add('clickable');
            countWrapper.setAttribute('onclick', `toggleTransactions(${ruleId}, this)`);
          }
        }
      }

      // Refresh expanded transactions panel if open
      const panel = document.getElementById(`txPanel-${ruleId}`);
      if (panel && panel.style.display !== 'none') {
        loadTransactions(ruleId, 1);
      }
    } catch (err) {
      notyf.error('Failed to reapply rule');
    } finally {
      btn.disabled = false;
    }
  }

  function formatAmount(amount) {
    if (amount === null || amount === undefined) return '-';
    const absAmount = Math.abs(amount);
    if (absAmount >= 10000000) return '\u20B9' + (absAmount / 10000000).toFixed(1) + 'Cr';
    if (absAmount >= 100000) return '\u20B9' + (absAmount / 100000).toFixed(1) + 'L';
    return '\u20B9' + absAmount.toLocaleString('en-IN');
  }

  function toggleTransactions(ruleId, clickedEl) {
    const panel = document.getElementById(`txPanel-${ruleId}`);
    if (panel.style.display === 'none') {
      panel.style.display = 'block';
      loadTransactions(ruleId, 1);
    } else {
      panel.style.display = 'none';
    }
  }

  async function loadTransactions(ruleId, page) {
    const loading = document.getElementById(`txLoading-${ruleId}`);
    const content = document.getElementById(`txContent-${ruleId}`);

    loading.style.display = 'flex';
    content.innerHTML = '';

    try {
      const response = await fetch(`/rules/${ruleId}/transactions?page=${page}&page_size=10`);
      if (!response.ok) throw new Error('Failed to load');
      const data = await response.json();

      loading.style.display = 'none';

      if (data.transactions.length === 0) {
        content.innerHTML = '<div class="tx-panel-empty">No transactions mapped to this rule</div>';
        return;
      }

      const totalPages = Math.ceil(data.total / data.page_size);
      const rows = data.transactions.map(tx => `
        <tr>
          <td>${tx.date}</td>
          <td title="${tx.description}">${tx.description.length > 45 ? tx.description.substring(0, 45) + '...' : tx.description}</td>
          <td>${tx.merchant || '-'}</td>
          <td class="amount-cell">${formatAmount(tx.amount)}</td>
          <td>${tx.category ? `<span class="category-badge" style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">${tx.category}</span>` : '-'}</td>
        </tr>
      `).join('');

      let html = `
        <table class="tx-panel-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Merchant</th>
              <th style="text-align: right;">Amount</th>
              <th>Category</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      if (totalPages > 1) {
        html += `
          <div class="tx-panel-pagination">
            <button class="btn btn-secondary btn-sm" onclick="loadTransactions(${ruleId}, ${page - 1})" ${page <= 1 ? 'disabled' : ''}>Prev</button>
            <span>Page ${page} of ${totalPages} (${data.total} total)</span>
            <button class="btn btn-secondary btn-sm" onclick="loadTransactions(${ruleId}, ${page + 1})" ${page >= totalPages ? 'disabled' : ''}>Next</button>
          </div>
        `;
      }

      content.innerHTML = html;
    } catch (err) {
      loading.style.display = 'none';
      content.innerHTML = '<div class="tx-panel-empty">Error loading transactions</div>';
    }
  }
</script>
{% endblock %}